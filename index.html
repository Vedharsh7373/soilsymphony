<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plant Care Dashboard</title>
  <style>
    :root {
      color-scheme: light;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%);
      color: #0c4a6e;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      color: white;
      padding: 1.5rem 2rem;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
    }
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .card {
      background: white;
      padding: 2.5rem;
      border-radius: 1.2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      max-width: 560px;
      width: 100%;
      text-align: center;
      border: 3px solid #14b8a6;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }
    .card h2 {
      color: #0c4a6e;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .status {
      font-size: 1.4rem;
      margin: 1.5rem 0;
      padding: 1.2rem;
      border-radius: 0.8rem;
      font-weight: bold;
      border: 3px solid #14b8a6;
      background: linear-gradient(135deg, #f0fdfa 0%, white 100%);
      transition: all 0.4s ease;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .status.wet {
      color: #059669;
      border-color: #10b981;
      background: linear-gradient(135deg, #d1fae5 0%, white 100%);
    }
    .status.dry {
      color: #dc2626;
      border-color: #ef4444;
      background: linear-gradient(135deg, #fee2e2 0%, white 100%);
    }
    .status.pump {
      color: #0284c7;
      border-color: #0ea5e9;
      background: linear-gradient(135deg, #e0f2fe 0%, white 100%);
    }
    button {
      background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%);
      color: white;
      border: 2px solid #14b8a6;
      padding: 1rem 1.8rem;
      font-size: 1.1rem;
      border-radius: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0.5rem;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    footer {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      text-align: center;
      padding: 1rem;
      font-size: 1rem;
      color: white;
      font-weight: bold;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    }
    .row {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .pill {
      padding: 0.6rem 1.2rem;
      border: 2px solid #14b8a6;
      border-radius: 25px;
      background: linear-gradient(135deg, white 0%, #f0fdfa 100%);
      color: #0c4a6e;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .pill.active {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      color: white;
    }
    #track {
      font-style: italic;
      color: #0c4a6e;
      font-weight: 500;
    }
    p strong {
      color: #0c4a6e;
    }
    #timerBox {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: #111827;
      color: #a7f3d0;
      font-family: monospace;
      border-radius: 6px;
      border: 2px solid #10b981;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 20;
      font-size: 14px;
      cursor: pointer;
    }
    #timerBox:hover {
      background: #1f2937;
    }
    .log {
      margin-top: 1rem;
      padding: 0.5rem;
      background: #f8fafc;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      color: #475569;
      max-height: 100px;
      overflow-y: auto;
      text-align: left;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      border: 3px solid #14b8a6;
    }
    .modal-content h3 {
      color: #0c4a6e;
      margin-top: 0;
    }
    .modal-content input {
      width: 100%;
      padding: 0.8rem;
      font-size: 1.1rem;
      border: 2px solid #14b8a6;
      border-radius: 0.5rem;
      margin: 1rem 0;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <header>üå± Plant Care Dashboard</header>
  <div id="timerBox" title="Click to edit timer">Timer: --:--</div>
  
  <main>
    <div class="card">
      <h2>Soil Condition</h2>
      <div id="status" class="status">
        Waiting for data‚Ä¶
      </div>
      
      <div class="row">
        <button id="connect">Connect to Arduino</button>
        <button id="toggle-audio">Enable Audio</button>
        <button id="manual-water">üíß Water Now</button>
      </div>
      
      <div style="margin-top: 1.5rem;">
        <p><strong>Now Playing:</strong> <span id="track">None</span></p>
        <div class="row">
          <span class="pill" id="serial-pill">Serial: disconnected</span>
        </div>
      </div>
      
      <div class="log" id="log">Console: Ready...</div>
    </div>
  </main>
  
  <footer>Made with üíõ for your plants</footer>

  <!-- Timer Edit Modal -->
  <div id="timerModal" class="modal">
    <div class="modal-content">
      <h3>‚è±Ô∏è Edit Timer Duration</h3>
      <p>Enter minutes (how long to wait before watering):</p>
      <input type="number" id="timerInput" min="1" max="60" value="5" />
      <div class="row">
        <button id="saveTimer">Save</button>
        <button id="cancelTimer">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Logging utility
    function log(msg) {
      const logDiv = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logDiv.textContent = `[${time}] ${msg}`;
      console.log(msg);
    }

    /* AUDIO ENGINE */
    let currentAudio = null;
    let audioEnabled = false;

    function stopAll() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
      }
    }

    async function playHappy() {
      if (!audioEnabled) {
        log("Audio disabled, skipping happy music");
        return;
      }
      stopAll();
      currentAudio = new Audio(
        "https://github.com/Vedharsh7373/soilsymphony/raw/main/432%20Hz%20-%20Positive%20Energy%20Meditation%20Music%20Deep%20Healing%20Music%20for%20The%20Body%20and%20Soul.mp3"
      );
      currentAudio.loop = true;
      currentAudio.volume = 0.5;
      try {
        await currentAudio.play();
        log("Playing happy music");
      } catch (err) {
        log("Audio playback failed: " + err.message);
      }
    }

    async function playSad() {
      if (!audioEnabled) {
        log("Audio disabled, skipping sad music");
        return;
      }
      stopAll();
      currentAudio = new Audio(
        "https://raw.githubusercontent.com/Vedharsh7373/soilsymphony/main/Record%20(online-voice-recorder.com).mp3"
      );
      currentAudio.loop = true;
      currentAudio.volume = 0.5;
      try {
        await currentAudio.play();
        log("Playing sad music");
      } catch (err) {
        log("Audio playback failed: " + err.message);
      }
    }

    /* UI + Timer */
    const statusDiv = document.getElementById("status");
    const track = document.getElementById("track");
    const serialPill = document.getElementById("serial-pill");
    const timerBox = document.getElementById("timerBox");
    const audioBtn = document.getElementById("toggle-audio");
    const connectBtn = document.getElementById("connect");
    const manualWaterBtn = document.getElementById("manual-water");
    const timerModal = document.getElementById("timerModal");
    const timerInput = document.getElementById("timerInput");
    const saveTimerBtn = document.getElementById("saveTimer");
    const cancelTimerBtn = document.getElementById("cancelTimer");

    let timerInterval = null;
    let remainingMs = 0;
    let currentMood = null;
    let timerRunning = false;
    let writer = null;
    let port = null;
    let timerMinutes = parseInt(localStorage.getItem("timerMinutes")) || 5;

    // Update timer input with saved value
    timerInput.value = timerMinutes;

    function updateTimerDisplay() {
      const totalSec = Math.floor(remainingMs / 1000);
      const min = String(Math.floor(totalSec / 60)).padStart(2, "0");
      const sec = String(totalSec % 60).padStart(2, "0");
      timerBox.textContent = `Timer: ${min}:${sec}`;
    }

    function startCountdown(ms) {
      if (timerRunning) {
        log("Timer already running");
        return;
      }
      log(`Starting ${timerMinutes}-minute countdown`);
      timerRunning = true;
      if (timerInterval) clearInterval(timerInterval);
      remainingMs = ms;
      updateTimerDisplay();
      
      timerInterval = setInterval(async () => {
        remainingMs -= 1000;
        if (remainingMs <= 0) {
          remainingMs = 0;
          clearInterval(timerInterval);
          timerInterval = null;
          timerRunning = false;
          updateTimerDisplay();
          
          log("Timer expired! Triggering pump");
          await activateServo();
        } else {
          updateTimerDisplay();
        }
      }, 1000);
    }

    function resetCountdown() {
      if (timerInterval) {
        clearInterval(timerInterval);
        log("Timer reset");
      }
      timerInterval = null;
      timerRunning = false;
      remainingMs = 0;
      timerBox.textContent = `Timer: --:--`;
    }

    async function activateServo() {
      if (!writer) {
        log("Error: Not connected to Arduino");
        return;
      }

      try {
        setPumpOn();
        
        // Step 1: Move 23 degrees
        log("Moving servo to 23¬∞");
        const encoder = new TextEncoder();
        await writer.write(encoder.encode("MOVE:23\n"));
        
        // Wait 3.5 seconds
        await new Promise(resolve => setTimeout(resolve, 3500));
        
        // Step 2: Move 157 degrees in opposite direction
        log("Moving servo to -157¬∞ (opposite direction)");
        await writer.write(encoder.encode("MOVE:-157\n"));
        
        // Wait for movement
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Step 3: Return to start
        log("Returning servo to 0¬∞");
        await writer.write(encoder.encode("MOVE:0\n"));
        
        log("Servo sequence complete");
        
        // After 4 seconds total, revert status
        setTimeout(() => {
          if (currentMood === "wet") {
            setWet();
          } else if (currentMood === "dry") {
            setDry();
          } else {
            statusDiv.textContent = "Waiting for sensor update...";
            statusDiv.className = "status";
          }
        }, 4000);
        
      } catch (e) {
        log("Servo control failed: " + e.message);
      }
    }

    function setWet() {
      if (currentMood === "wet") return;
      currentMood = "wet";
      statusDiv.textContent = "Plant is Happy üòä (Wet)";
      statusDiv.className = "status wet";
      playHappy();
      track.textContent = "432 Hz ‚Äì Music For Plant Growth";
      resetCountdown();
      log("State: WET");
    }

    function setDry() {
      if (currentMood === "dry") return;
      currentMood = "dry";
      statusDiv.textContent = "Plant is Sad üò¢ (Dry)";
      statusDiv.className = "status dry";
      playSad();
      track.textContent = "A Cry For Help";
      startCountdown(timerMinutes * 60 * 1000);
      log("State: DRY");
    }

    function setPumpOn() {
      statusDiv.textContent = "Pump Activated üíß (3.5s)";
      statusDiv.className = "status pump";
      track.textContent = "Watering in progress...";
      log("State: PUMP_ON");
    }

    /* SERIAL CONNECTION */
    connectBtn.addEventListener("click", async () => {
      try {
        if (!("serial" in navigator)) {
          alert("Web Serial API not supported. Use Chrome/Edge.");
          return;
        }

        if (port) {
          log("Already connected");
          return;
        }

        log("Requesting serial port...");
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        
        serialPill.textContent = "Serial: connected";
        serialPill.classList.add("active");
        connectBtn.disabled = true;
        log("Connected to Arduino");

        // Writer setup
        const textEncoder = new TextEncoderStream();
        textEncoder.readable.pipeTo(port.writable);
        writer = textEncoder.writable.getWriter();

        // Reader
        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();

        let buffer = "";
        
        // Read loop
        while (true) {
          const { value, done } = await reader.read();
          if (done) {
            log("Serial connection closed");
            break;
          }
          if (!value) continue;

          buffer += value;
          let idx;
          
          while ((idx = buffer.indexOf("\n")) >= 0) {
            const line = buffer.slice(0, idx).trim();
            buffer = buffer.slice(idx + 1);
            
            if (!line) continue;
            
            log("RX: " + line);

            // Parse incoming messages
            if (line.includes("WET") || line.includes("MOIST")) {
              setWet();
            } else if (line.includes("DRY")) {
              setDry();
            }

            // Handle STATE messages
            if (line.startsWith("STATE:")) {
              const state = line.substring(6).trim();
              if (state === "DRY") {
                setDry();
              } else if (state === "WET" || state === "MOIST") {
                setWet();
              }
            }
          }
        }
      } catch (err) {
        serialPill.textContent = "Serial: failed";
        serialPill.classList.remove("active");
        connectBtn.disabled = false;
        log("Error: " + err.message);
        port = null;
        writer = null;
      }
    });

    /* Enable/Disable Audio */
    audioBtn.addEventListener("click", () => {
      audioEnabled = !audioEnabled;
      
      if (audioEnabled) {
        audioBtn.textContent = "Disable Audio";
        audioBtn.style.background = "linear-gradient(135deg, #dc2626 0%, #ef4444 100%)";
        audioBtn.style.borderColor = "#ef4444";
        track.textContent = "Audio enabled - waiting for plant status";
        log("Audio enabled");
      } else {
        stopAll();
        audioBtn.textContent = "Enable Audio";
        audioBtn.style.background = "linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%)";
        audioBtn.style.borderColor = "#14b8a6";
        track.textContent = "None";
        log("Audio disabled");
      }
    });

    /* Manual Water Button */
    manualWaterBtn.addEventListener("click", async () => {
      if (!writer) {
        alert("Please connect to Arduino first!");
        log("Manual water failed: Not connected");
        return;
      }
      
      resetCountdown();
      await activateServo();
    });

    /* Timer Modal */
    timerBox.addEventListener("click", () => {
      if (timerRunning) {
        log("Cannot edit timer while running");
        return;
      }
      timerModal.classList.add("show");
    });

    cancelTimerBtn.addEventListener("click", () => {
      timerModal.classList.remove("show");
    });

    saveTimerBtn.addEventListener("click", () => {
      const newMinutes = parseInt(timerInput.value);
      if (newMinutes >= 1 && newMinutes <= 60) {
        timerMinutes = newMinutes;
        localStorage.setItem("timerMinutes", timerMinutes);
        log(`Timer set to ${timerMinutes} minutes`);
        timerModal.classList.remove("show");
      } else {
        alert("Please enter a value between 1 and 60 minutes");
      }
    });

    log(`Dashboard ready. Timer set to ${timerMinutes} minutes. Click 'Connect to Arduino' to begin.`);
  </script>
</body>
</html>
