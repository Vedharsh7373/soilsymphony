<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SoilSymphony: Evolution Dashboard</title>
    <style>
        :root {
            --bg: #05070a; --card: #101425;
            --hp-color: #ff4757; --xp-color: #2ed573;
            --accent-blue: #3b82f6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; text-align: center; padding: 20px; }
        .game-container { max-width: 700px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 30px; border: 4px solid #1e293b; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* Progress Bars */
        .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; color: #94a3b8; }
        .bar { width: 100%; height: 15px; background: #000; border-radius: 10px; margin-bottom: 15px; overflow: hidden; border: 1px solid #334155; }
        .fill { height: 100%; transition: width 0.4s ease; }
        
        /* Plant Visuals */
        #stage-display { font-size: 100px; margin: 20px 0; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .dead { filter: grayscale(1) opacity(0.5); transform: rotate(90deg); }

        .btn-connect { background: var(--accent-blue); color: white; border: none; padding: 15px 30px; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .log-box { background: #000; padding: 10px; height: 80px; overflow-y: auto; font-family: monospace; font-size: 11px; margin-top: 20px; border-radius: 10px; color: #55ff55; text-align: left; }
    </style>
</head>
<body>

<div class="game-container">
    <h1 style="color: var(--xp-color); letter-spacing: 3px;">ðŸŒ± SOIL SYMPHONY</h1>
    <p id="level-tag" style="color: #94a3b8;">LEVEL 1: SPROUT</p>

    <div id="stage-display">ðŸŒ±</div>

    <div class="bar-label"><span>Plant Health</span><span id="hp-val">100%</span></div>
    <div class="bar"><div id="hp-fill" class="fill" style="width: 100%; background: var(--hp-color);"></div></div>

    <div class="bar-label"><span>Growth XP</span><span id="xp-val">0%</span></div>
    <div class="bar"><div id="xp-fill" class="fill" style="width: 0%; background: var(--xp-color);"></div></div>

    <p id="msg" style="font-style: italic; margin-bottom: 20px;">Link sensor to begin music & growth...</p>
    
    <div id="sensor-data" style="margin-bottom: 20px; display: none;">
        <span style="font-size: 24px; font-weight: bold;" id="raw-val">---</span>
        <div style="font-size: 12px; opacity: 0.6;">CURRENT SOIL READING</div>
    </div>

    <button class="btn-connect" id="connectBtn">CONNECT ARDUINO</button>
    
    <div class="log-box" id="log">System initialized...</div>
</div>

<script>
    let wetMusic = null, dryAlert = null;
    let hp = 100, xp = 0, level = 1, isDead = false;
    let reader = null, currentlyPlaying = null;

    const MUSIC_URLS = {
        wet: 'https://raw.githubusercontent.com/Vedharsh7373/soilsymphony/main/432%20Hz%20-%20Positive%20Energy%20Meditation%20Music%20Deep%20Healing%20Music%20for%20The%20Body%20and%20Soul.mp3',
        dry: 'https://raw.githubusercontent.com/Vedharsh7373/soilsymphony/main/Record%20(online-voice-recorder.com).mp3'
    };

    function initAudio() {
        if (!wetMusic) {
            wetMusic = new Audio(MUSIC_URLS.wet); wetMusic.loop = true;
            dryAlert = new Audio(MUSIC_URLS.dry); dryAlert.loop = true;
        }
    }

    function processGameLogic(state) {
        if (isDead) return;
        const stage = document.getElementById('stage-display');
        const msg = document.getElementById('msg');

        if (state === 'DRY') {
            hp -= 3;
            msg.textContent = "ALARM! I'm thirsty!";
            playAudio('dry');
            stage.style.transform = "scale(0.85) rotate(5deg)";
        } else if (state === 'WET') {
            if (hp < 100) hp += 1;
            msg.textContent = "Soothing... 432Hz Healing Active.";
            playAudio('wet');
            stage.style.transform = "scale(1.1) rotate(-5deg)";
        } else {
            xp += 5;
            msg.textContent = "Vibe is perfect. I am growing.";
            stopAudio();
            stage.style.transform = "scale(1) rotate(0deg)";
        }

        if (hp <= 0) { isDead = true; stage.classList.add('dead'); msg.textContent = "GAME OVER: Plant Withered."; stopAudio(); }
        if (xp >= 100) { level++; xp = 0; evolvePlant(); }
        updateUI();
    }

    function evolvePlant() {
        const icons = ["ðŸŒ±", "ðŸŒ¿", "ðŸª´", "ðŸ€", "ðŸŒ¸", "ðŸŒ»", "ðŸŒ³", "ðŸŒŸ"];
        document.getElementById('stage-display').textContent = icons[Math.min(level-1, 7)];
        document.getElementById('level-tag').textContent = `LEVEL ${level}: ${level > 5 ? 'ANCIENT' : 'GROWING'}`;
        log("Evolved to Level " + level + "!");
    }

    function playAudio(type) {
        if (currentlyPlaying === type) return;
        stopAudio();
        if (type === 'wet') wetMusic.play(); else dryAlert.play();
        currentlyPlaying = type;
    }

    function stopAudio() {
        if (wetMusic) wetMusic.pause(); if (dryAlert) dryAlert.pause();
        currentlyPlaying = null;
    }

    function updateUI() {
        document.getElementById('hp-fill').style.width = hp + "%";
        document.getElementById('hp-val').textContent = hp + "%";
        document.getElementById('xp-fill').style.width = xp + "%";
        document.getElementById('xp-val').textContent = xp + "%";
    }

    function log(m) {
        const l = document.getElementById('log');
        l.innerHTML = `[${new Date().toLocaleTimeString()}] ${m}<br>${l.innerHTML}`;
    }

    async function connect() {
        initAudio();
        try {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('sensor-data').style.display = 'block';
            
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            readLoop();
        } catch (e) { log("Error: " + e.message); }
    }

    async function readLoop() {
        let buffer = '';
        while (true) {
            const { value, done } = await reader.read();
            buffer += value;
            let lines = buffer.split('\n');
            buffer = lines.pop();
            for (let line of lines) {
                if (line.includes('Soil:')) {
                    const val = parseInt(line.match(/\d+/)[0]);
                    document.getElementById('raw-val').textContent = val;
                    let state = line.includes('WET') ? 'WET' : (line.includes('DRY') ? 'DRY' : 'NORMAL');
                    processGameLogic(state);
                }
            }
        }
    }

    document.getElementById('connectBtn').addEventListener('click', connect);
</script>
</body>
</html>
