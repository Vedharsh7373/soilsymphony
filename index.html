  try {
    const port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    serialPill.textContent = "Serial: connected";
    const decoder = new TextDecoderStream();
    const readableClosed = port.readable.pipeTo(decoder.writable);
    const reader = decoder.readable.getReader();
    let buffer = "";
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (!value) continue;
      buffer += value;
      let idx;
      while ((idx = buffer.indexOf("\n")) >= 0) {
        const line = buffer.slice(0, idx).trim();
        buffer = buffer.slice(idx + 1);
        if (!line) continue;
        if (line.includes("WET")) setWet();
        else if (line.includes("DRY")) setDry();
      }
    }
  } catch (e) {
    console.error(e);
    serialPill.textContent = "Serial: failed";
    alert("Serial connection failed. Ensure you're in Chrome/Edge with Web Serial enabled.");
  }
});
</script>
</body>
</html>
