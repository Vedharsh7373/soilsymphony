<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plant Care Dashboard</title>
  <style>
    :root {
      color-scheme: light;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%);
      color: #0c4a6e;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      color: white;
      padding: 1.5rem 2rem;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
    }
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .card {
      background: white;
      padding: 2.5rem;
      border-radius: 1.2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      max-width: 560px;
      width: 100%;
      text-align: center;
      border: 3px solid #14b8a6;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }
    .card h2 {
      color: #0c4a6e;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .status {
      font-size: 1.4rem;
      margin: 1.5rem 0;
      padding: 1.2rem;
      border-radius: 0.8rem;
      font-weight: bold;
      border: 3px solid #14b8a6;
      background: linear-gradient(135deg, #f0fdfa 0%, white 100%);
      transition: all 0.4s ease;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .status.wet {
      color: #059669;
      border-color: #10b981;
      background: linear-gradient(135deg, #d1fae5 0%, white 100%);
    }
    .status.dry {
      color: #dc2626;
      border-color: #ef4444;
      background: linear-gradient(135deg, #fee2e2 0%, white 100%);
    }
    .status.pump {
      color: #0284c7;
      border-color: #0ea5e9;
      background: linear-gradient(135deg, #e0f2fe 0%, white 100%);
    }
    button {
      background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%);
      color: white;
      border: 2px solid #14b8a6;
      padding: 1rem 1.8rem;
      font-size: 1.1rem;
      border-radius: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0.5rem;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    footer {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      text-align: center;
      padding: 1rem;
      font-size: 1rem;
      color: white;
      font-weight: bold;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    }
    .row {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .pill {
      padding: 0.6rem 1.2rem;
      border: 2px solid #14b8a6;
      border-radius: 25px;
      background: linear-gradient(135deg, white 0%, #f0fdfa 100%);
      color: #0c4a6e;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .pill.active {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      color: white;
    }
    #track {
      font-style: italic;
      color: #0c4a6e;
      font-weight: 500;
    }
    p strong {
      color: #0c4a6e;
    }
    #timerBox {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: #111827;
      color: #a7f3d0;
      font-family: monospace;
      border-radius: 6px;
      border: 2px solid #10b981;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 20;
      font-size: 14px;
    }
    .log {
      margin-top: 1rem;
      padding: 0.5rem;
      background: #f8fafc;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      color: #475569;
      max-height: 100px;
      overflow-y: auto;
      text-align: left;
    }
  </style>
</head>
<body>
  <header>ðŸŒ± Plant Care Dashboard</header>
  <div id="timerBox">Timer: --:--</div>
  
  <main>
    <div class="card">
      <h2>Soil Condition</h2>
      <div id="status" class="status">
        Waiting for dataâ€¦
      </div>
      
      <div class="row">
        <button id="connect">Connect to Arduino</button>
        <button id="toggle-audio">Enable Audio</button>
        <button id="manual-pump" disabled>Manual Water ðŸ’§</button>
      </div>
      
      <div style="margin-top: 1.5rem;">
        <p><strong>Now Playing:</strong> <span id="track">None</span></p>
        <div class="row">
          <span class="pill" id="serial-pill">Serial: disconnected</span>
        </div>
      </div>
      
      <div class="log" id="log">Console: Ready...</div>
    </div>
  </main>
  
  <footer>Made with ðŸ’› for your plants</footer>

  <script>
    // Logging utility
    function log(msg) {
      const logDiv = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logDiv.textContent = `[${time}] ${msg}`;
      console.log(msg);
    }

    /* AUDIO ENGINE */
    let currentAudio = null;
    let audioEnabled = false;

    function stopAll() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
      }
    }

    async function playHappy() {
      if (!audioEnabled) {
        log("Audio disabled, skipping happy music");
        return;
      }
      stopAll();
      currentAudio = new Audio(
        "https://github.com/Vedharsh7373/soilsymphony/raw/main/432%20Hz%20-%20Positive%20Energy%20Meditation%20Music%20Deep%20Healing%20Music%20for%20The%20Body%20and%20Soul.mp3"
      );
      currentAudio.loop = true;
      currentAudio.volume = 0.5;
      try {
        await currentAudio.play();
        log("Playing happy music");
      } catch (err) {
        log("Audio playback failed: " + err.message);
      }
    }

    async function playSad() {
      if (!audioEnabled) {
        log("Audio disabled, skipping sad music");
        return;
      }
      stopAll();
      currentAudio = new Audio(
        "https://raw.githubusercontent.com/Vedharsh7373/soilsymphony/main/Record%20(online-voice-recorder.com).mp3"
      );
      currentAudio.loop = true;
      currentAudio.volume = 0.5;
      try {
        await currentAudio.play();
        log("Playing sad music");
      } catch (err) {
        log("Audio playback failed: " + err.message);
      }
    }

    /* UI + Timer */
    const statusDiv = document.getElementById("status");
    const track = document.getElementById("track");
    const serialPill = document.getElementById("serial-pill");
    const timerBox = document.getElementById("timerBox");
    const audioBtn = document.getElementById("toggle-audio");
    const connectBtn = document.getElementById("connect");
    const manualPumpBtn = document.getElementById("manual-pump");

    let timerInterval = null;
    let remainingMs = 0;
    let currentMood = null;
    let timerRunning = false;
    let writer = null;
    let port = null;

    function updateTimerDisplay() {
      const totalSec = Math.floor(remainingMs / 1000);
      const min = String(Math.floor(totalSec / 60)).padStart(2, "0");
      const sec = String(totalSec % 60).padStart(2, "0");
      timerBox.textContent = `Timer: ${min}:${sec}`;
    }

    function startCountdown(ms) {
      if (timerRunning) {
        log("Timer already running");
        return;
      }
      log("Starting 15-minute countdown");
      timerRunning = true;
      if (timerInterval) clearInterval(timerInterval);
      remainingMs = ms;
      updateTimerDisplay();
      
      timerInterval = setInterval(async () => {
        remainingMs -= 1000;
        if (remainingMs <= 0) {
          remainingMs = 0;
          clearInterval(timerInterval);
          timerInterval = null;
          timerRunning = false;
          updateTimerDisplay();
          
          log("Timer expired! Sending PUMP_ON command");
          if (writer) {
            try {
              await writer.write("PUMP_ON\n");
              log("PUMP_ON command sent");
            } catch (e) {
              log("Failed to send PUMP_ON: " + e.message);
            }
          }
        } else {
          updateTimerDisplay();
        }
      }, 1000);
    }

    function resetCountdown() {
      if (timerInterval) {
        clearInterval(timerInterval);
        log("Timer reset");
      }
      timerInterval = null;
      timerRunning = false;
      remainingMs = 0;
      timerBox.textContent = "Timer: --:--";
    }

    function setWet() {
      if (currentMood === "wet") return;
      currentMood = "wet";
      statusDiv.textContent = "Plant is Happy ðŸ˜Š (Wet)";
      statusDiv.className = "status wet";
      playHappy();
      track.textContent = "432 Hz â€“ Music For Plant Growth";
      resetCountdown();
      log("State: WET");
    }

    function setDry() {
      if (currentMood === "dry") return;
      currentMood = "dry";
      statusDiv.textContent = "Plant is Sad ðŸ˜¢ (Dry)";
      statusDiv.className = "status dry";
      playSad();
      track.textContent = "A Cry For Help";
      startCountdown(15 * 60 * 1000); // Start 15-minute timer
      log("State: DRY");
    }

    function setPumpOn() {
      statusDiv.textContent = "Pump Activated ðŸ’§";
      statusDiv.className = "status pump";
      track.textContent = "Watering in progress...";
      log("State: PUMP_ON");
    }

    /* SERIAL CONNECTION */
    connectBtn.addEventListener("click", async () => {
      try {
        if (!("serial" in navigator)) {
          alert("Web Serial API not supported. Use Chrome/Edge.");
          return;
        }

        if (port) {
          log("Already connected");
          return;
        }

        log("Requesting serial port...");
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        
        serialPill.textContent = "Serial: connected";
        serialPill.classList.add("active");
        connectBtn.disabled = true;
        manualPumpBtn.disabled = false;
        log("Connected to Arduino");

        // Writer
        const textEncoder = new TextEncoderStream();
        const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
        writer = textEncoder.writable.getWriter();

        // Reader
        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();

        let buffer = "";
        
        // Read loop
        while (true) {
          const { value, done } = await reader.read();
          if (done) {
            log("Serial connection closed");
            break;
          }
          if (!value) continue;

          buffer += value;
          let idx;
          
          while ((idx = buffer.indexOf("\n")) >= 0) {
            const line = buffer.slice(0, idx).trim();
            buffer = buffer.slice(idx + 1);
            
            if (!line) continue;
            
            log("RX: " + line);

            // Parse incoming messages
            if (line.includes("WET") || line.includes("MOIST")) {
              setWet();
            } else if (line.includes("DRY")) {
              setDry();
            } else if (line.includes("PUMP_ON")) {
              setPumpOn();
            }

            // Handle STATE messages
            if (line.startsWith("STATE:")) {
              const state = line.substring(6).trim();
              if (state === "DRY") {
                setDry();
              } else if (state === "WET" || state === "MOIST") {
                setWet();
              }
            }
          }
        }
      } catch (err) {
        serialPill.textContent = "Serial: failed";
        serialPill.classList.remove("active");
        connectBtn.disabled = false;
        manualPumpBtn.disabled = true;
        log("Error: " + err.message);
        port = null;
        writer = null;
      }
    });

    /* Manual Pump Control */
    manualPumpBtn.addEventListener("click", async () => {
      if (!writer) {
        log("No serial connection");
        return;
      }
      
      // Disable button during watering
      manualPumpBtn.disabled = true;
      setPumpOn();
      log("Manual pump ON - watering for 5 seconds");
      
      try {
        // Send PUMP_ON command (writer already handles encoding)
        await writer.write("PUMP_ON\n");
        log("TX: PUMP_ON");
        
        // Auto turn off after 5 seconds
        setTimeout(async () => {
          try {
            await writer.write("PUMP_OFF\n");
            log("TX: PUMP_OFF");
            manualPumpBtn.disabled = false;
            
            // Return to previous state
            if (currentMood === "wet") {
              setWet();
            } else if (currentMood === "dry") {
              setDry();
            } else {
              statusDiv.textContent = "Manual watering complete";
              statusDiv.className = "status";
              track.textContent = "None";
            }
          } catch (e) {
            log("Failed to send PUMP_OFF: " + e.message);
            manualPumpBtn.disabled = false;
          }
        }, 5000);
      } catch (e) {
        log("Failed to send PUMP_ON: " + e.message);
        manualPumpBtn.disabled = false;
      }
    });

    /* Enable/Disable Audio */
    audioBtn.addEventListener("click", () => {
      audioEnabled = !audioEnabled;
      
      if (audioEnabled) {
        audioBtn.textContent = "Disable Audio";
        audioBtn.style.background = "linear-gradient(135deg, #dc2626 0%, #ef4444 100%)";
        audioBtn.style.borderColor = "#ef4444";
        track.textContent = "Audio enabled - waiting for plant status";
        log("Audio enabled");
      } else {
        stopAll();
        audioBtn.textContent = "Enable Audio";
        audioBtn.style.background = "linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%)";
        audioBtn.style.borderColor = "#14b8a6";
        track.textContent = "None";
        log("Audio disabled");
      }
    });

    log("Dashboard ready. Click 'Connect to Arduino' to begin.");
  </script>
</body>
</html>
